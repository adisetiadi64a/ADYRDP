name: Free RDP via LocalXpose (Fixed 2025 - New URL)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
    - name: üå± Set up user
      run: |
        $user = "Adysetia64"
        $pass = ConvertTo-SecureString "Test1234!" -AsPlainText -Force
        New-LocalUser $user -Password $pass
        Add-LocalGroupMember -Group "Administrators" -Member $user
        Write-Host "‚úÖ User $user created successfully with password Test1234!"

    - name: üî• Disable Windows Firewall (All Profiles)
      run: |
        Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
        Write-Host "‚úÖ Firewall disabled for all profiles."

    - name: ‚öôÔ∏è Download LocalXpose binary (Updated URL)
      run: |
        $url = "https://api.localxpose.io/api/downloads/loclx-windows-amd64.zip"
        Write-Host "‚¨áÔ∏è Downloading LocalXpose from $url"
        Invoke-WebRequest -Uri $url -OutFile "loclx.zip"
        Expand-Archive -Path "loclx.zip" -DestinationPath "."
        if (-not (Test-Path ".\loclx.exe")) {
          Write-Error "‚ùå loclx.exe not found after extraction."
          exit 1
        }
        Write-Host "‚úÖ LocalXpose binary ready!"

    - name: üîë Authenticate LocalXpose (use repo secret)
      env:
        TOKEN: ${{ secrets.LOCALXPOSE_TOKEN }}
      run: |
        if (-not $env:TOKEN) {
          Write-Error "‚ùå LOCALXPOSE_TOKEN secret missing!"
          exit 1
        }
        .\loclx.exe account login --token $env:TOKEN
        Write-Host "‚úÖ LocalXpose authenticated."

    - name: üöÄ Start LocalXpose TCP Tunnel (RDP)
      run: |
        Start-Process -FilePath ".\loclx.exe" -ArgumentList "tunnel", "tcp", "--to", "3389" -NoNewWindow
        Start-Sleep -Seconds 10
        Write-Host "‚úÖ Tunnel started successfully."

    - name: üíª Show RDP Access Info
      run: |
        Write-Host "===================================="
        Write-Host "‚úÖ USERNAME: Adysetia64"
        Write-Host "‚úÖ PASSWORD: Test1234!"
        Write-Host "üëâ Check your tunnel on: https://localxpose.io/dashboard/tunnels"
        Write-Host "===================================="
