name: Free RDP via LocalXpose (Fixed 2025)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
    - name: üå± Set up user
      run: |
        $user = "Adysetia64"
        $pass = ConvertTo-SecureString "Test1234!" -AsPlainText -Force
        New-LocalUser $user -Password $pass
        Add-LocalGroupMember -Group "Administrators" -Member $user
        Write-Host "‚úÖ User $user created successfully with password Test1234!"

    - name: üî• Disable Windows Firewall (All Profiles)
      run: |
        Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
        Write-Host "‚úÖ Firewall disabled for all profiles."

    - name: ‚öôÔ∏è Download LocalXpose binary (auto-fix path)
      run: |
        Invoke-WebRequest -Uri "https://files.localxpose.io/localxpose/latest/windows-amd64.zip" -OutFile "lx.zip"
        Expand-Archive -Path "lx.zip" -DestinationPath "."
        $exe = Get-ChildItem -Path "." -Filter "lx.exe" -Recurse | Select-Object -First 1
        if ($exe -eq $null) {
          Write-Error "‚ùå lx.exe not found after extraction."
          exit 1
        }
        Move-Item $exe.FullName ".\lx.exe" -Force
        Write-Host "‚úÖ LocalXpose binary prepared successfully."

    - name: üîë Authenticate LocalXpose (use repo secret)
      env:
        TOKEN: ${{ secrets.LOCALXPOSE_TOKEN }}
      run: |
        if (-not $env:TOKEN) {
          Write-Error "‚ùå LOCALXPOSE_TOKEN secret missing!"
          exit 1
        }
        ./lx.exe account login --token $env:TOKEN
        Write-Host "‚úÖ LocalXpose authenticated."

    - name: üöÄ Start LocalXpose TCP Tunnel (RDP)
      run: |
        Start-Process -FilePath ".\lx.exe" -ArgumentList "tunnel", "tcp", "--to", "3389" -NoNewWindow
        Start-Sleep -Seconds 10
        Write-Host "‚úÖ Tunnel started successfully."

    - name: üíª Show RDP Access Info
      run: |
        Write-Host "===================================="
        Write-Host "‚úÖ USERNAME: Adysetia64"
        Write-Host "‚úÖ PASSWORD: Test1234!"
        Write-Host "Check your TCP link on:"
        Write-Host "üëâ https://localxpose.io/dashboard/tunnels"
        Write-Host "===================================="
