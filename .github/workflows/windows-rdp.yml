name: Free RDP via LocalXpose

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
    - name: üß© Set up user
      run: |
        $user = "Adysetia64"
        $pass = ConvertTo-SecureString "Test1234!" -AsPlainText -Force
        New-LocalUser $user -Password $pass
        Add-LocalGroupMember -Group "Administrators" -Member $user
        Write-Host "User $user created successfully with password Test1234!"

    - name: üî• Disable Windows Firewall (All Profiles)
      run: |
        Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
        Write-Host "‚úÖ Firewall disabled for all profiles."

    - name: ‚öôÔ∏è Download LocalXpose binary
      run: |
        Invoke-WebRequest -Uri "https://files.localxpose.io/localxpose/latest/windows-amd64.zip" -OutFile "lx.zip"
        Expand-Archive lx.zip -DestinationPath .
        Rename-Item -Path ".\windows-amd64\lx.exe" -NewName "lx.exe"
        Write-Host "‚úÖ LocalXpose binary downloaded successfully."

    - name: üîë Authenticate LocalXpose (use repo secret)
      env:
        TOKEN: ${{ secrets.LOCALXPOSE_TOKEN }}
      run: |
        if (-not $env:TOKEN) {
          Write-Error "‚ùå LOCALXPOSE_TOKEN secret is missing!"
          exit 1
        }
        ./lx.exe account login --token $env:TOKEN
        Write-Host "‚úÖ LocalXpose authenticated."

    - name: üöÄ Start LocalXpose TCP Tunnel (RDP) & capture output
      run: |
        Start-Process -FilePath "lx.exe" -ArgumentList "tunnel", "tcp", "--to", "3389" -NoNewWindow
        Start-Sleep -Seconds 10
        Write-Host "‚úÖ RDP Tunnel started successfully."

    - name: üíª Show RDP Access Info (final)
      run: |
        Write-Host "==============================="
        Write-Host "‚úÖ RDP Username: Adysetia64"
        Write-Host "‚úÖ RDP Password: Test1234!"
        Write-Host "==============================="
        Write-Host "Check LocalXpose Dashboard to get your TCP link:"
        Write-Host "üëâ https://localxpose.io/dashboard/tunnels"
